name: DB Workflow
on:
  workflow_call:
    secrets:
      DB_ROOT_PASSWORD:
        required: true
      DB_USER:
        required: true
      DB_PASSWORD:
        required: true
      PAT:
        required: true   # dump.sql 커밋에 필요하다면

jobs:
  dump:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code (write enabled)
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.PAT }}
          fetch-depth: 0
          persist-credentials: true

      - name: Start MySQL container
        run: |
          docker run -d --name mysql-db \
            -e MYSQL_DATABASE=test \
            -e MYSQL_ROOT_PASSWORD=${{ secrets.DB_ROOT_PASSWORD }} \
            -e MYSQL_USER=${{ secrets.DB_USER }} \
            -e MYSQL_PASSWORD=${{ secrets.DB_PASSWORD }} \
            -p 3307:3306 \
            mysql:8.0 \
            --default-authentication-plugin=mysql_native_password

      - name: Wait for MySQL
        run: |
          until docker exec mysql-db mysqladmin ping -h127.0.0.1 --silent \
            --user=root --password=${{ secrets.DB_ROOT_PASSWORD }}; do
            sleep 1
          done

      - name: Seed sample table & data
        run: |
          docker exec mysql-db mysql \
            --user=root --password=${{ secrets.DB_ROOT_PASSWORD }} \
            --database=test \
            -e "
              CREATE TABLE IF NOT EXISTS sample (
                id INT AUTO_INCREMENT PRIMARY KEY,
                name VARCHAR(50) NOT NULL
              );
              INSERT INTO sample (name) VALUES
                ('Alice'),('Bob'),('Charlie')
              ON DUPLICATE KEY UPDATE name=name;
            "

      - name: Dump database to SQL
        run: |
          docker exec mysql-db mysqldump \
            --user=${{ secrets.DB_USER }} \
            --password=${{ secrets.DB_PASSWORD }} \
            test > dump.sql

      - name: Commit dump.sql back to repo
        run: |
          git add dump.sql
          if ! git diff --cached --quiet; then
            git commit -m "chore: update database dump"
            git push https://x-access-token:${{ secrets.PAT }}@github.com/${{ github.repository }}.git HEAD:main
          else
            echo "No changes to dump.sql"
          fi
